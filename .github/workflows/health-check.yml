name: Health Check

on:
  schedule:
    # Ch·∫°y health check m·ªói 30 ph√∫t
    - cron: '*/30 * * * *'
  workflow_dispatch: # Cho ph√©p ch·∫°y th·ªß c√¥ng

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check server health
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "üè• Checking chatbot service health..."
          
          # Ki·ªÉm tra service status
          if sudo systemctl is-active --quiet chatbot-whoisme.service; then
            echo "‚úÖ Service is running"
          else
            echo "‚ùå Service is not running! Attempting restart..."
            sudo systemctl start chatbot-whoisme.service
            sleep 5
            if sudo systemctl is-active --quiet chatbot-whoisme.service; then
              echo "‚úÖ Service restarted successfully"
            else
              echo "‚ùå Failed to restart service"
              sudo journalctl -u chatbot-whoisme.service --no-pager -l -n 10
              exit 1
            fi
          fi
          
          # Ki·ªÉm tra port
          if netstat -tlnp | grep -q ":8200 "; then
            echo "‚úÖ Port 8200 is listening"
          else
            echo "‚ùå Port 8200 is not accessible"
            exit 1
          fi
          
          # Ki·ªÉm tra HTTP response
          if curl -f -s http://localhost:8200/health > /dev/null; then
            echo "‚úÖ Health endpoint responding"
          else
            echo "‚ö†Ô∏è Health endpoint not responding, checking root endpoint"
            if curl -f -s http://localhost:8200/ > /dev/null; then
              echo "‚úÖ Root endpoint responding"
            else
              echo "‚ùå HTTP endpoints not responding"
              exit 1
            fi
          fi
          
          # Ch·∫°y health check script n·∫øu c√≥
          PROJECT_DIR="${{ secrets.PROJECT_ROOT }}/chatbot_base"
          if [ -f "$PROJECT_DIR/health_check.py" ]; then
            echo "üîç Running detailed health check..."
            cd $PROJECT_DIR
            source venv/bin/activate
            python health_check.py
          fi
          
          echo "üéâ Health check completed successfully!"

    - name: Notify if failed
      if: failure()
      run: |
        echo "‚ùå Health check failed! Please investigate the server."
        echo "::warning::Server health check failed - manual intervention may be required"

    - name: Send Telegram notification for health check
      if: failure()
      run: |
        CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
        
        MESSAGE="üö® *Health Check Failed!*
        
        üè• *Service:* Chatbot Health Monitor
        üñ•Ô∏è *Server:* \`${{ secrets.SERVER_HOST }}\`
        üïê *Time:* \`${CURRENT_TIME}\`
        
        ‚ùå *Issues detected:*
        ‚Ä¢ Service may be down
        ‚Ä¢ Port 8200 not responding
        ‚Ä¢ System resources critical
        
        üîß *Action required:* Please check server status immediately!"
        
        # Send to Telegram (only if secrets are configured)
        if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="${MESSAGE}" \
            || echo "Failed to send Telegram notification"
        else
          echo "Telegram secrets not configured, skipping notification"
        fi