name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Cho phÃ©p trigger thá»§ cÃ´ng

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          # Äá»‹nh nghÄ©a cÃ¡c biáº¿n
          PROJECT_DIR="${{ secrets.PROJECT_ROOT }}/chatbot_base"
          
          echo "ğŸš€ Starting deployment to $PROJECT_DIR"
          
          # Clone hoáº·c pull code má»›i vá»›i error handling
          if [ -d "$PROJECT_DIR" ]; then
            echo "ğŸ”„ Updating existing repository..."
            cd $PROJECT_DIR
            
            # Stash any local changes
            git stash push -m "Auto-stash before deployment $(date)" || true
            
            # Fetch and reset
            git fetch origin || { echo "âŒ Failed to fetch from origin"; exit 1; }
            git reset --hard origin/main || { echo "âŒ Failed to reset to origin/main"; exit 1; }
            git clean -fd || { echo "âŒ Failed to clean repository"; exit 1; }
            
            echo "âœ… Repository updated successfully"
          else
            echo "ğŸ“¥ Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git $PROJECT_DIR || { 
              echo "âŒ Failed to clone repository"; 
              exit 1; 
            }
            cd $PROJECT_DIR
            echo "âœ… Repository cloned successfully"
          fi
          
          echo "âœ… Code updated successfully"
          
          # KÃ­ch hoáº¡t virtual environment vá»›i error handling
          echo "ğŸ Setting up Python environment..."
          if [ ! -d "venv" ]; then
            echo "ğŸ“¦ Creating virtual environment..."
            python3 -m venv venv || { echo "âŒ Failed to create virtual environment"; exit 1; }
            echo "âœ… Virtual environment created"
          else
            echo "â™»ï¸ Using existing virtual environment"
          fi
          
          source venv/bin/activate || { echo "âŒ Failed to activate virtual environment"; exit 1; }
          
          # CÃ i Ä‘áº·t dependencies
          echo "ğŸ“¦ Installing dependencies..."
          pip install --upgrade pip
          pip install -r requirements.txt || { echo "âŒ Failed to install requirements"; exit 1; }
          pip install gunicorn python-dotenv
          
          # Function to update or add environment variable
          update_env_var() {
            local key="\$1"
            local value="\$2"
            local file=".env"
            
            if [ -n "\$value" ]; then
              if grep -q "^\${key}=" "\$file" 2>/dev/null; then
                # Update existing variable
                sed -i "s|^\${key}=.*|\${key}=\${value}|" "\$file"
                echo "  âœ“ Updated \${key}"
              else
                # Add new variable
                echo "\${key}=\${value}" >> "\$file"
                echo "  âœ“ Added \${key}"
              fi
            fi
          }
          
          # Táº¡o file .env
          echo "âš™ï¸ Creating/updating .env file..."
          [ ! -f ".env" ] && echo "PROJECT_ROOT=PLACEHOLDER" > .env
          
          # Update environment variables
          update_env_var "PROJECT_ROOT" "${{ secrets.PROJECT_ROOT }}"
          update_env_var "GOOGLE_API_KEY" "${{ secrets.GOOGLE_API_KEY }}"
          update_env_var "DEEPSEEK_API_KEY" "${{ secrets.DEEPSEEK_API_KEY }}"
          update_env_var "GROK_API_KEY" "${{ secrets.GROK_API_KEY }}"
          update_env_var "OPEN_API_KEY" "${{ secrets.OPEN_API_KEY }}"
          update_env_var "SUPABASE_URL" "${{ secrets.SUPABASE_URL }}"
          update_env_var "SUPABASE_KEY" "${{ secrets.SUPABASE_KEY }}"
          update_env_var "POSTGRES_URL" "${{ secrets.POSTGRES_URL }}"
          update_env_var "CHATBOT_API_KEY" "${{ secrets.CHATBOT_API_KEY }}"
          update_env_var "OPENAI_API_KEY" "${{ secrets.OPENAI_API_KEY }}"
          update_env_var "GOOGLE_SHEET_ID" "${{ secrets.GOOGLE_SHEET_ID }}"
          update_env_var "JWT_SECRET" "${{ secrets.JWT_SECRET }}"
          update_env_var "APP_SECRET_KEY" "${{ secrets.APP_SECRET_KEY }}"
          
          # Táº¡o thÆ° má»¥c logs vÃ  chuáº©n bá»‹ scripts
          mkdir -p ${{ secrets.PROJECT_ROOT }}/logs
          chmod +x deploy-service.sh service.sh start.sh 2>/dev/null || true
          
          # Táº¡o service template náº¿u chÆ°a cÃ³ hoáº·c cáº­p nháº­t template hiá»‡n cÃ³
          echo "ğŸ“ Creating/updating service template..."
          echo '[Unit]' > chatbot-whoisme.service.template
          echo 'Description=Chatbot WhoIsMe AI Application' >> chatbot-whoisme.service.template
          echo 'After=network.target' >> chatbot-whoisme.service.template
          echo 'Wants=network.target' >> chatbot-whoisme.service.template
          echo '' >> chatbot-whoisme.service.template
          echo '[Service]' >> chatbot-whoisme.service.template
          echo 'Type=exec' >> chatbot-whoisme.service.template
          echo 'User=root' >> chatbot-whoisme.service.template
          echo 'Group=root' >> chatbot-whoisme.service.template
          echo 'WorkingDirectory={{PROJECT_ROOT}}/chatbot_base' >> chatbot-whoisme.service.template
          echo 'Environment=PROJECT_ROOT={{PROJECT_ROOT}}' >> chatbot-whoisme.service.template
          echo 'Environment=PATH={{PROJECT_ROOT}}/chatbot_base/venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' >> chatbot-whoisme.service.template
          echo 'Environment=PYTHONPATH={{PROJECT_ROOT}}/chatbot_base' >> chatbot-whoisme.service.template
          echo 'ExecStart={{PROJECT_ROOT}}/chatbot_base/venv/bin/gunicorn --config {{PROJECT_ROOT}}/chatbot_base/gunicorn.conf.py ai_bot:app' >> chatbot-whoisme.service.template
          echo 'ExecReload=/bin/kill -s HUP $MAINPID' >> chatbot-whoisme.service.template
          echo 'KillMode=mixed' >> chatbot-whoisme.service.template
          echo 'TimeoutStopSec=5' >> chatbot-whoisme.service.template
          echo 'PrivateTmp=true' >> chatbot-whoisme.service.template
          echo 'Restart=always' >> chatbot-whoisme.service.template
          echo 'RestartSec=10' >> chatbot-whoisme.service.template
          echo 'StandardOutput=append:{{PROJECT_ROOT}}/logs/service.log' >> chatbot-whoisme.service.template
          echo 'StandardError=append:{{PROJECT_ROOT}}/logs/service.log' >> chatbot-whoisme.service.template
          echo '' >> chatbot-whoisme.service.template
          echo '[Install]' >> chatbot-whoisme.service.template
          echo 'WantedBy=multi-user.target' >> chatbot-whoisme.service.template
          
          # Deploy service
          echo "ğŸš€ Deploying service..."
          if ! ./deploy-service.sh; then
            # Manual fallback
            sed "s|{{PROJECT_ROOT}}|${{ secrets.PROJECT_ROOT }}|g" chatbot-whoisme.service.template > chatbot-whoisme.service
            sudo cp chatbot-whoisme.service /etc/systemd/system/
            sudo systemctl daemon-reload
            sudo systemctl stop chatbot-whoisme.service 2>/dev/null || true
            sudo systemctl enable --now chatbot-whoisme.service
          fi
          
          # Kiá»ƒm tra service
          echo "ğŸ” Verifying service..."
          sleep 3
          if sudo systemctl is-active --quiet chatbot-whoisme.service; then
            echo "âœ… Service is running!"
            sudo systemctl status chatbot-whoisme.service --no-pager -l
          else
            echo "âŒ Service failed to start!"
            sudo journalctl -u chatbot-whoisme.service --no-pager -n 20
            exit 1
          fi

    - name: Send Telegram notification
      if: always()
      run: |
        # Prepare deployment info
        COMMIT_MSG=$(git log -1 --pretty=%B | head -1)
        COMMIT_AUTHOR=$(git log -1 --pretty=%an)
        COMMIT_HASH=$(git log -1 --pretty=%h)
        DEPLOY_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
        
        # Determine status and message
        if [ "${{ job.status }}" == "success" ]; then
          MESSAGE="ğŸš€ *Deployment Successful!*
        
        ğŸ“¦ *Repository:* \`${{ github.repository }}\`
        ğŸŒ¿ *Branch:* \`${{ github.ref_name }}\`
        ğŸ‘¤ *Author:* \`${COMMIT_AUTHOR}\`
        ğŸ’¬ *Commit:* \`${COMMIT_HASH}\` - ${COMMIT_MSG}
        ğŸ• *Time:* \`${DEPLOY_TIME}\`
        ğŸ–¥ï¸ *Server:* \`${{ secrets.SERVER_HOST }}\`
        
        âœ… Chatbot service is now running!"
        else
          MESSAGE="ğŸš¨ *Deployment Failed!*
        
        ğŸ“¦ *Repository:* \`${{ github.repository }}\`
        ğŸŒ¿ *Branch:* \`${{ github.ref_name }}\`
        ğŸ‘¤ *Author:* \`${COMMIT_AUTHOR}\`
        ğŸ’¬ *Commit:* \`${COMMIT_HASH}\` - ${COMMIT_MSG}
        ğŸ• *Time:* \`${DEPLOY_TIME}\`
        ğŸ–¥ï¸ *Server:* \`${{ secrets.SERVER_HOST }}\`
        
        âŒ Please check the deployment logs!"
        fi
        
        # Send to Telegram
        if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="${MESSAGE}"
        fi