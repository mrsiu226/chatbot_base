name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Cho phÃ©p trigger thá»§ cÃ´ng

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests (optional)
      run: |
        # Uncomment náº¿u cÃ³ tests
        # python -m pytest tests/ || echo "No tests found"
        echo "Skipping tests for now"

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          # Äá»‹nh nghÄ©a cÃ¡c biáº¿n
          PROJECT_DIR="${{ secrets.PROJECT_ROOT }}/chatbot_base"
          BACKUP_DIR="${{ secrets.PROJECT_ROOT }}/backups"
          
          echo "ðŸš€ Starting deployment to $PROJECT_DIR"
          
          # Táº¡o thÆ° má»¥c backup náº¿u chÆ°a cÃ³
          mkdir -p $BACKUP_DIR
          
          # Backup code hiá»‡n táº¡i (náº¿u cÃ³)
          if [ -d "$PROJECT_DIR" ]; then
            echo "ðŸ“¦ Creating backup..."
            BACKUP_NAME="chatbot_backup_$(date +%Y%m%d_%H%M%S)"
            cp -r $PROJECT_DIR $BACKUP_DIR/$BACKUP_NAME
            echo "âœ… Backup created: $BACKUP_DIR/$BACKUP_NAME"
          fi
          
          # Clone hoáº·c pull code má»›i
          if [ -d "$PROJECT_DIR" ]; then
            echo "ðŸ”„ Updating existing repository..."
            cd $PROJECT_DIR
            git fetch origin
            git reset --hard origin/main
            git clean -fd
          else
            echo "ðŸ“¥ Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git $PROJECT_DIR
            cd $PROJECT_DIR
          fi
          
          echo "âœ… Code updated successfully"
          
          # KÃ­ch hoáº¡t virtual environment
          echo "ðŸ Setting up Python environment..."
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi
          source venv/bin/activate
          
          # CÃ i Ä‘áº·t dependencies
          echo "ðŸ“¦ Installing dependencies..."
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install gunicorn
          
          # Kiá»ƒm tra vÃ  táº¡o file .env náº¿u cáº§n
          if [ ! -f ".env" ]; then
            echo "âš™ï¸ Creating .env file..."
            echo "PROJECT_ROOT=${{ secrets.PROJECT_ROOT }}" > .env
            echo "# Add other environment variables as needed" >> .env
          fi
          
          # Äáº£m báº£o PROJECT_ROOT trong .env Ä‘Æ°á»£c cáº­p nháº­t
          if grep -q "^PROJECT_ROOT=" .env; then
            sed -i "s|^PROJECT_ROOT=.*|PROJECT_ROOT=${{ secrets.PROJECT_ROOT }}|" .env
          else
            echo "PROJECT_ROOT=${{ secrets.PROJECT_ROOT }}" >> .env
          fi
          
          # Táº¡o thÆ° má»¥c logs
          mkdir -p ${{ secrets.PROJECT_ROOT }}/logs
          
          # Deploy service
          echo "ðŸ”§ Deploying systemd service..."
          chmod +x deploy-service.sh service.sh start.sh
          
          # Táº¡o service template náº¿u chÆ°a cÃ³
          if [ ! -f "chatbot-whoisme.service.template" ]; then
            echo "ðŸ“ Creating service template..."
            cat > chatbot-whoisme.service.template << 'EOF'
          [Unit]
          Description=Chatbot WhoIsMe Service
          After=network.target

          [Service]
          Type=forking
          User=$USER
          Group=$USER
          WorkingDirectory={{PROJECT_ROOT}}/chatbot_base
          ExecStart={{PROJECT_ROOT}}/chatbot_base/start.sh
          ExecReload=/bin/kill -HUP $MAINPID
          KillMode=mixed
          TimeoutStopSec=5
          PrivateTmp=true
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          EOF
          fi
          
          # Cháº¡y deploy script
          ./deploy-service.sh
          
          # Kiá»ƒm tra tráº¡ng thÃ¡i service
          sleep 5
          if sudo systemctl is-active --quiet chatbot-whoisme.service; then
            echo "âœ… Service is running successfully!"
            sudo systemctl status chatbot-whoisme.service --no-pager -l
          else
            echo "âŒ Service failed to start. Checking logs..."
            sudo journalctl -u chatbot-whoisme.service --no-pager -l -n 20
            exit 1
          fi
          
          echo "ðŸŽ‰ Deployment completed successfully!"

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment successful!"
        else
          echo "âŒ Deployment failed!"
        fi

    - name: Send Telegram notification
      if: always()
      run: |
        # Prepare deployment info
        COMMIT_MSG=$(git log -1 --pretty=%B | head -1)
        COMMIT_AUTHOR=$(git log -1 --pretty=%an)
        COMMIT_HASH=$(git log -1 --pretty=%h)
        DEPLOY_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
        
        # Determine status and emoji
        if [ "${{ job.status }}" == "success" ]; then
          STATUS="âœ… SUCCESS"
          MESSAGE="ðŸš€ *Deployment Successful!*
        
        ðŸ“¦ *Repository:* \`${{ github.repository }}\`
        ðŸŒ¿ *Branch:* \`${{ github.ref_name }}\`
        ðŸ‘¤ *Author:* \`${COMMIT_AUTHOR}\`
        ðŸ’¬ *Commit:* \`${COMMIT_HASH}\` - \`${COMMIT_MSG}\`
        ðŸ• *Time:* \`${DEPLOY_TIME}\`
        ðŸ–¥ï¸ *Server:* \`${{ secrets.SERVER_HOST }}\`
        
        âœ… Chatbot service is now running with the latest code!"
        else
          STATUS="âŒ FAILED"
          MESSAGE="ðŸš¨ *Deployment Failed!*
        
        ðŸ“¦ *Repository:* \`${{ github.repository }}\`
        ðŸŒ¿ *Branch:* \`${{ github.ref_name }}\`
        ðŸ‘¤ *Author:* \`${COMMIT_AUTHOR}\`
        ðŸ’¬ *Commit:* \`${COMMIT_HASH}\` - \`${COMMIT_MSG}\`
        ðŸ• *Time:* \`${DEPLOY_TIME}\`
        ðŸ–¥ï¸ *Server:* \`${{ secrets.SERVER_HOST }}\`
        
        âŒ Please check the deployment logs and fix the issues."
        fi
        
        # Send to Telegram
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d parse_mode="Markdown" \
          -d text="${MESSAGE}" \
          || echo "Failed to send Telegram notification"