name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Cho phÃ©p trigger thá»§ cÃ´ng

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests (optional)
      run: |
        # Uncomment náº¿u cÃ³ tests
        # python -m pytest tests/ || echo "No tests found"
        echo "Skipping tests for now"

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          # Äá»‹nh nghÄ©a cÃ¡c biáº¿n
          PROJECT_DIR="${{ secrets.PROJECT_ROOT }}/chatbot_base"
          BACKUP_DIR="${{ secrets.PROJECT_ROOT }}/backups"
          
          echo "ğŸš€ Starting deployment to $PROJECT_DIR"
          
          # Táº¡o thÆ° má»¥c backup náº¿u chÆ°a cÃ³
          mkdir -p $BACKUP_DIR
          
          # Backup code hiá»‡n táº¡i (náº¿u cÃ³)
          if [ -d "$PROJECT_DIR" ]; then
            echo "ğŸ“¦ Creating backup..."
            BACKUP_NAME="chatbot_backup_$(date +%Y%m%d_%H%M%S)"
            cp -r $PROJECT_DIR $BACKUP_DIR/$BACKUP_NAME
            echo "âœ… Backup created: $BACKUP_DIR/$BACKUP_NAME"
          fi
          
          # Clone hoáº·c pull code má»›i vá»›i error handling
          if [ -d "$PROJECT_DIR" ]; then
            echo "ğŸ”„ Updating existing repository..."
            cd $PROJECT_DIR
            
            # Stash any local changes
            git stash push -m "Auto-stash before deployment $(date)" || true
            
            # Fetch and reset
            git fetch origin || { echo "âŒ Failed to fetch from origin"; exit 1; }
            git reset --hard origin/main || { echo "âŒ Failed to reset to origin/main"; exit 1; }
            git clean -fd || { echo "âŒ Failed to clean repository"; exit 1; }
            
            echo "âœ… Repository updated successfully"
          else
            echo "ğŸ“¥ Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git $PROJECT_DIR || { 
              echo "âŒ Failed to clone repository"; 
              exit 1; 
            }
            cd $PROJECT_DIR
            echo "âœ… Repository cloned successfully"
          fi
          
          echo "âœ… Code updated successfully"
          
          # KÃ­ch hoáº¡t virtual environment vá»›i error handling
          echo "ğŸ Setting up Python environment..."
          if [ ! -d "venv" ]; then
            echo "ğŸ“¦ Creating virtual environment..."
            python3 -m venv venv || { echo "âŒ Failed to create virtual environment"; exit 1; }
            echo "âœ… Virtual environment created"
          else
            echo "â™»ï¸ Using existing virtual environment"
          fi
          
          source venv/bin/activate || { echo "âŒ Failed to activate virtual environment"; exit 1; }
          echo "âœ… Virtual environment activated"
          
          # Verify Python environment
          python --version
          which python
          which pip
          
          # CÃ i Ä‘áº·t dependencies vá»›i error handling
          echo "ğŸ“¦ Installing dependencies..."
          pip install --upgrade pip
          
          # Install requirements vá»›i retry vÃ  error handling
          for i in {1..3}; do
            if pip install -r requirements.txt; then
              echo "âœ… Requirements installed successfully"
              break
            else
              echo "âš ï¸ Attempt $i/3: Failed to install requirements, retrying..."
              if [ $i -eq 3 ]; then
                echo "âŒ Failed to install requirements after 3 attempts"
                exit 1
              fi
              sleep 5
            fi
          done
          
          # Install gunicorn
          pip install gunicorn python-dotenv
          
          # Backup .env file náº¿u tá»“n táº¡i
          if [ -f ".env" ]; then
            echo "ğŸ’¾ Backing up existing .env file..."
            cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
          fi
          
          # Function to update or add environment variable
          update_env_var() {
            local key="\$1"
            local value="\$2"
            local file=".env"
            
            if [ -n "\$value" ]; then
              if grep -q "^\${key}=" "\$file" 2>/dev/null; then
                # Update existing variable
                sed -i "s|^\${key}=.*|\${key}=\${value}|" "\$file"
                echo "  âœ“ Updated \${key}"
              else
                # Add new variable
                echo "\${key}=\${value}" >> "\$file"
                echo "  âœ“ Added \${key}"
              fi
            fi
          }
          
          # Táº¡o file .env cÆ¡ báº£n náº¿u chÆ°a cÃ³
          echo "âš™ï¸ Creating/updating .env file..."
          if [ ! -f ".env" ]; then
            echo "# Project configuration - DO NOT EDIT THIS LINE" > .env
            echo "PROJECT_ROOT=PLACEHOLDER" >> .env
          fi
          
          # Always update PROJECT_ROOT (required)
          update_env_var "PROJECT_ROOT" "${{ secrets.PROJECT_ROOT }}"
          
          # Update API keys only if provided in secrets
          if [ -n "${{ secrets.GOOGLE_API_KEY }}" ]; then
            update_env_var "GOOGLE_API_KEY" "${{ secrets.GOOGLE_API_KEY }}"
          fi
          
          if [ -n "${{ secrets.DEEPSEEK_API_KEY }}" ]; then
            update_env_var "DEEPSEEK_API_KEY" "${{ secrets.DEEPSEEK_API_KEY }}"
          fi
          
          if [ -n "${{ secrets.GROK_API_KEY }}" ]; then
            update_env_var "GROK_API_KEY" "${{ secrets.GROK_API_KEY }}"
          fi
          
          if [ -n "${{ secrets.SUPABASE_URL }}" ]; then
            update_env_var "SUPABASE_URL" "${{ secrets.SUPABASE_URL }}"
          fi
          
          if [ -n "${{ secrets.SUPABASE_KEY }}" ]; then
            update_env_var "SUPABASE_KEY" "${{ secrets.SUPABASE_KEY }}"
          fi
          
          if [ -n "${{ secrets.POSTGRES_URL }}" ]; then
            update_env_var "POSTGRES_URL" "${{ secrets.POSTGRES_URL }}"
          fi
          
          if [ -n "${{ secrets.CHATBOT_API_KEY }}" ]; then
            update_env_var "CHATBOT_API_KEY" "${{ secrets.CHATBOT_API_KEY }}"
          fi
          
          # Add any additional environment variables here
          # Example: update_env_var "NEW_VARIABLE" "${{ secrets.NEW_VARIABLE }}"
          
          # ThÃªm cÃ¡c biáº¿n má»›i tá»« secrets náº¿u cÃ³
          # Danh sÃ¡ch cÃ¡c biáº¿n cÃ³ thá»ƒ thÃªm:
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            update_env_var "OPENAI_API_KEY" "${{ secrets.OPENAI_API_KEY }}"
          fi
          
          if [ -n "${{ secrets.GOOGLE_SHEET_ID }}" ]; then
            update_env_var "GOOGLE_SHEET_ID" "${{ secrets.GOOGLE_SHEET_ID }}"
          fi
          
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            update_env_var "JWT_SECRET" "${{ secrets.JWT_SECRET }}"
          fi
          
          if [ -n "${{ secrets.APP_SECRET_KEY }}" ]; then
            update_env_var "APP_SECRET_KEY" "${{ secrets.APP_SECRET_KEY }}"
          fi
          
          # Display updated environment variables (without sensitive values)
          echo "ğŸ“‹ Environment variables configured:"
          grep -E "^[A-Z_]+" .env | sed 's/=.*/=***/' | while read line; do
            echo "  $line"
          done
          
          # Táº¡o thÆ° má»¥c logs
          mkdir -p ${{ secrets.PROJECT_ROOT }}/logs
          
          # Chuáº©n bá»‹ deployment scripts
          echo "ğŸ”§ Preparing deployment scripts..."
          chmod +x deploy-service.sh service.sh start.sh 2>/dev/null || {
            echo "âš ï¸ Some scripts not found, creating them..."
          }
          
          # Äáº£m báº£o scripts tá»“n táº¡i vÃ  cÃ³ quyá»n thá»±c thi
          if [ -f "deploy-service.sh" ]; then
            chmod +x deploy-service.sh
          fi
          if [ -f "service.sh" ]; then
            chmod +x service.sh
          fi
          if [ -f "start.sh" ]; then
            chmod +x start.sh
          fi
          
          # Táº¡o service template náº¿u chÆ°a cÃ³ hoáº·c cáº­p nháº­t template hiá»‡n cÃ³
          echo "ğŸ“ Creating/updating service template..."
          echo '[Unit]' > chatbot-whoisme.service.template
          echo 'Description=Chatbot WhoIsMe AI Application' >> chatbot-whoisme.service.template
          echo 'After=network.target' >> chatbot-whoisme.service.template
          echo 'Wants=network.target' >> chatbot-whoisme.service.template
          echo '' >> chatbot-whoisme.service.template
          echo '[Service]' >> chatbot-whoisme.service.template
          echo 'Type=exec' >> chatbot-whoisme.service.template
          echo 'User=root' >> chatbot-whoisme.service.template
          echo 'Group=root' >> chatbot-whoisme.service.template
          echo 'WorkingDirectory={{PROJECT_ROOT}}/chatbot_base' >> chatbot-whoisme.service.template
          echo 'Environment=PROJECT_ROOT={{PROJECT_ROOT}}' >> chatbot-whoisme.service.template
          echo 'Environment=PATH={{PROJECT_ROOT}}/chatbot_base/venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' >> chatbot-whoisme.service.template
          echo 'Environment=PYTHONPATH={{PROJECT_ROOT}}/chatbot_base' >> chatbot-whoisme.service.template
          echo 'ExecStart={{PROJECT_ROOT}}/chatbot_base/venv/bin/gunicorn --config {{PROJECT_ROOT}}/chatbot_base/gunicorn.conf.py ai_bot:app' >> chatbot-whoisme.service.template
          echo 'ExecReload=/bin/kill -s HUP $MAINPID' >> chatbot-whoisme.service.template
          echo 'KillMode=mixed' >> chatbot-whoisme.service.template
          echo 'TimeoutStopSec=5' >> chatbot-whoisme.service.template
          echo 'PrivateTmp=true' >> chatbot-whoisme.service.template
          echo 'Restart=always' >> chatbot-whoisme.service.template
          echo 'RestartSec=10' >> chatbot-whoisme.service.template
          echo 'StandardOutput=append:{{PROJECT_ROOT}}/logs/service.log' >> chatbot-whoisme.service.template
          echo 'StandardError=append:{{PROJECT_ROOT}}/logs/service.log' >> chatbot-whoisme.service.template
          echo '' >> chatbot-whoisme.service.template
          echo '[Install]' >> chatbot-whoisme.service.template
          echo 'WantedBy=multi-user.target' >> chatbot-whoisme.service.template
          
          # Cháº¡y deploy script vá»›i error handling
          echo "ğŸš€ Running deployment script..."
          if ./deploy-service.sh; then
            echo "âœ… Deploy script completed successfully"
          else
            echo "âŒ Deploy script failed. Trying manual steps..."
            
            # Manual fallback deployment
            echo "ğŸ”§ Manual service deployment..."
            
            # Generate service file manually
            sed "s|{{PROJECT_ROOT}}|${{ secrets.PROJECT_ROOT }}|g" chatbot-whoisme.service.template > chatbot-whoisme.service
            
            # Deploy service manually
            sudo cp chatbot-whoisme.service /etc/systemd/system/
            sudo systemctl daemon-reload
            
            # Stop service if running
            sudo systemctl stop chatbot-whoisme.service 2>/dev/null || true
            
            # Enable and start service
            sudo systemctl enable chatbot-whoisme.service
            sudo systemctl start chatbot-whoisme.service
          fi
          
          # Kiá»ƒm tra tráº¡ng thÃ¡i service vá»›i retry
          echo "ğŸ” Checking service status..."
          for i in {1..5}; do
            sleep 2
            if sudo systemctl is-active --quiet chatbot-whoisme.service; then
              echo "âœ… Service is running successfully!"
              sudo systemctl status chatbot-whoisme.service --no-pager -l
              
              # Test HTTP endpoint
              echo "ğŸŒ Testing HTTP endpoint..."
              if curl -s -I http://127.0.0.1:8200/ | grep -q "HTTP/1.1"; then
                echo "âœ… HTTP endpoint is responding"
              else
                echo "âš ï¸ HTTP endpoint not responding yet, but service is running"
              fi
              break
            else
              echo "â³ Attempt $i/5: Service not ready yet..."
              if [ $i -eq 5 ]; then
                echo "âŒ Service failed to start after 5 attempts. Checking logs..."
                sudo journalctl -u chatbot-whoisme.service --no-pager -l -n 30
                echo "ğŸ“‹ Service file content:"
                cat /etc/systemd/system/chatbot-whoisme.service
                exit 1
              fi
            fi
          done
          
          # Final validation
          echo "ğŸ” Final deployment validation..."
          
          # Check if service is enabled for auto-start
          if sudo systemctl is-enabled --quiet chatbot-whoisme.service; then
            echo "âœ… Service is enabled for auto-start"
          else
            echo "âš ï¸ Service is not enabled for auto-start"
            sudo systemctl enable chatbot-whoisme.service
          fi
          
          # Display final status
          echo "ğŸ“Š Final deployment status:"
          echo "  - Service status: $(sudo systemctl is-active chatbot-whoisme.service)"
          echo "  - Service enabled: $(sudo systemctl is-enabled chatbot-whoisme.service)"
          echo "  - Process count: $(ps aux | grep gunicorn | grep -v grep | wc -l)"
          echo "  - Port 8200: $(netstat -tlnp | grep 8200 | wc -l) listener(s)"
          
          echo "ğŸ‰ Deployment completed successfully!"

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment successful!"
        else
          echo "âŒ Deployment failed!"
        fi

    - name: Send Telegram notification
      if: always()
      run: |
        # Prepare deployment info
        COMMIT_MSG=$(git log -1 --pretty=%B | head -1)
        COMMIT_AUTHOR=$(git log -1 --pretty=%an)
        COMMIT_HASH=$(git log -1 --pretty=%h)
        DEPLOY_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
        
        # Determine status and emoji
        if [ "${{ job.status }}" == "success" ]; then
          STATUS="âœ… SUCCESS"
          MESSAGE="ğŸš€ *Deployment Successful!*
        
        ğŸ“¦ *Repository:* \`${{ github.repository }}\`
        ğŸŒ¿ *Branch:* \`${{ github.ref_name }}\`
        ğŸ‘¤ *Author:* \`${COMMIT_AUTHOR}\`
        ğŸ’¬ *Commit:* \`${COMMIT_HASH}\` - \`${COMMIT_MSG}\`
        ğŸ• *Time:* \`${DEPLOY_TIME}\`
        ğŸ–¥ï¸ *Server:* \`${{ secrets.SERVER_HOST }}\`
        
        âœ… Chatbot service is now running with the latest code!"
        else
          STATUS="âŒ FAILED"
          MESSAGE="ğŸš¨ *Deployment Failed!*
        
        ğŸ“¦ *Repository:* \`${{ github.repository }}\`
        ğŸŒ¿ *Branch:* \`${{ github.ref_name }}\`
        ğŸ‘¤ *Author:* \`${COMMIT_AUTHOR}\`
        ğŸ’¬ *Commit:* \`${COMMIT_HASH}\` - \`${COMMIT_MSG}\`
        ğŸ• *Time:* \`${DEPLOY_TIME}\`
        ğŸ–¥ï¸ *Server:* \`${{ secrets.SERVER_HOST }}\`
        
        âŒ Please check the deployment logs and fix the issues."
        fi
        
        # Send to Telegram if tokens are available
        if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
          echo "ğŸ“± Sending Telegram notification..."
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="${MESSAGE}" \
            && echo "âœ… Telegram notification sent successfully" \
            || echo "âŒ Failed to send Telegram notification"
        else
          echo "âš ï¸ Telegram credentials not configured, skipping notification"
        fi