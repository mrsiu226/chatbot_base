name: Simple Health Check

on:
  schedule:
    # Cháº¡y health check má»—i 1 giá»
    - cron: '0 * * * *'
  workflow_dispatch: # Cho phÃ©p cháº¡y thá»§ cÃ´ng

jobs:
  basic-health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Ping server
      run: |
        echo "ğŸ  Checking server connectivity..."
        if ping -c 3 ${{ secrets.SERVER_HOST }}; then
          echo "âœ… Server is reachable"
        else
          echo "âŒ Server is not reachable"
          exit 1
        fi

  detailed-health-check:
    runs-on: ubuntu-latest
    needs: basic-health-check
    if: success()
    
    steps:
    - name: SSH Health Check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        timeout: 30s
        script: |
          echo "ğŸ¥ Starting comprehensive health check..."
          
          # 1. Kiá»ƒm tra systemd service
          echo "1ï¸âƒ£ Checking service status..."
          if systemctl is-active --quiet chatbot-whoisme.service 2>/dev/null; then
            echo "âœ… Service is active"
            systemctl status chatbot-whoisme.service --no-pager -l | head -10
          else
            echo "âŒ Service is not active - attempting restart..."
            sudo systemctl start chatbot-whoisme.service || true
            sleep 3
            if systemctl is-active --quiet chatbot-whoisme.service 2>/dev/null; then
              echo "âœ… Service restarted successfully"
            else
              echo "âŒ Service restart failed"
              sudo journalctl -u chatbot-whoisme.service -n 5 --no-pager || true
            fi
          fi
          
          # 2. Kiá»ƒm tra port listening
          echo "2ï¸âƒ£ Checking port 8200..."
          if ss -tuln | grep -q ":8200 "; then
            echo "âœ… Port 8200 is listening"
          elif netstat -tuln 2>/dev/null | grep -q ":8200 "; then
            echo "âœ… Port 8200 is listening"
          else
            echo "âŒ Port 8200 is not accessible"
          fi
          
          # 3. Kiá»ƒm tra process
          echo "3ï¸âƒ£ Checking gunicorn process..."
          if pgrep -f "gunicorn.*ai_bot" > /dev/null; then
            echo "âœ… Gunicorn process is running"
            pgrep -f "gunicorn.*ai_bot" | head -3
          else
            echo "âŒ Gunicorn process not found"
          fi
          
          # 4. Kiá»ƒm tra disk space
          echo "4ï¸âƒ£ Checking disk space..."
          df -h | grep -E "(Filesystem|/dev/)" | head -5
          
          # 5. Kiá»ƒm tra memory
          echo "5ï¸âƒ£ Checking memory usage..."
          free -h
          
          # 6. Test HTTP response
          echo "6ï¸âƒ£ Testing HTTP endpoints..."
          if command -v curl > /dev/null; then
            if curl -s -f http://localhost:8200/health > /dev/null; then
              echo "âœ… /health endpoint OK"
            elif curl -s -f http://localhost:8200/ > /dev/null; then
              echo "âœ… Root endpoint OK"
            else
              echo "âš ï¸ HTTP endpoints not responding"
            fi
          else
            echo "â„¹ï¸ curl not available, skipping HTTP test"
          fi
          
          echo "ğŸ‰ Health check completed!"

    - name: Log results
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Health check passed"
        else
          echo "âŒ Health check failed - check server status"
        fi